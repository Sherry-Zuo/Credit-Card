---
title: "Credit Card Customer Segmentation"
subtitle: BA820 - Fall 2019
author: "team 7"
date: "11/20/2019"
output: html_document
---

**Team 7 Members:** Kunpeng Huang, Yoki Liu, Lyufan Pan, Yunlei Zhou, Jiayuan Zou, Sherry Zuo
```{r}
## load the packages
library(readr)
library(ggplot2)
library(dplyr)
library(purrr)
library(cluster)
library(factoextra)
library(tidyverse)
library(skimr)
library(corrplot)
library(plotly)
library(Rtsne)
```

```{r}
## load the dataset
data<-read_csv("CC GENERAL.csv")
```

```{r}
colnames(data)<-tolower(colnames(data))
colnames(data)
```

```{r}
##Data Cleaning
cc<-data%>%select(-cust_id)
colmean <- function(x) replace(x, is.na(x), mean(x, na.rm = TRUE))
cc <- replace(cc, TRUE, lapply(cc, colmean))
glimpse(cc)
skim(cc)
##There are 17 numeric variables and 8950 observations. Replace NAs with colmeans. 
```
```{r}
summary(lm(credit_limit~. , cc))
```

```{r fig.width=12, fig.height=12}
cc_c<-cor(cc)
corrplot(cc_c,
         type="upper",
         diag=F,
         method="color",
         order="hclust")
```
Based on the correlation plot colors, we think there are more than 4 clusters in our dataset.
```{r}
##Explore data
ggplot(cc,aes(x=purchases_frequency)) +
  geom_histogram()+
  theme(panel.background = element_rect(fill="white"))
```
Based on this histigram, this graph shows us that the purchasing polarization. x-axis indicates that how frequently the purchases are being made, 1 = very frequently, and 0 = not very frequently. Most of transcations is concetred on the either not very frequently or very frequently group.
```{r}
ggplot(cc, aes(x = balance_frequency, y = balance, color = factor(tenure)))+
  geom_point(alpha = 0.2)+
  theme(panel.background = element_rect(fill="white"))
```
```{r}
##cash_advance_frequency with cash_advance_trx
##purchases with purchases_installments_frequency
##purchases_frequency with purchases_installments_frequency
ggplot(cc, aes(x = purchases_installments_frequency, y = purchases, color = purchases_frequency))+
  geom_point()+
  theme(panel.background = element_rect(fill="white"))
```
 
```{r}
##balance
par(mfrow = c(2,1))
hist(x=cc$balance)
boxplot(cc$balance, horizontal = T)
```
```{r}
##balance freq: both withdraw and saving
par(mfrow = c(2,1))
hist(x=cc$balance_frequency)
boxplot(cc$balance_frequency, horizontal = T)
```
```{r}
##purchases
par(mfrow = c(2,1))
hist(x=cc$purchases)
boxplot(cc$purchases, horizontal = T)
```
```{r}
##purchase freq
par(mfrow = c(2,1))
hist(x=cc$purchases_frequency)
boxplot(cc$purchases_frequency, horizontal = T)
```
```{r}
##oneoff purchase: maximum purchase amount
par(mfrow = c(2,1))
hist(x=cc$oneoff_purchases)
boxplot(cc$oneoff_purchases, horizontal = T)
```
```{r}
##oneoff purchase frequency: maximum purchase refresh freq
par(mfrow = c(2,1))
hist(x=cc$oneoff_purchases_frequency)
boxplot(cc$oneoff_purchases_frequency, horizontal = T)
```
```{r}
##oneoff purchase: maximum installment amount
par(mfrow = c(2,1))
hist(x=cc$installments_purchases)
boxplot(cc$installments_purchases, horizontal = T)
```

```{r}
## Hclust
cc_z = scale(cc)
#Manhattan distance: 
cc_dm = dist(cc_z, method="manhattan")
#Complete linkage: 
clust = hclust(cc_dm)
table(cutree(clust, k=7))
sapply(7:13, function(x) table(cutree(clust, k=x)))
```

```{r}
##Fit the PCA model
cc_pca=prcomp(cc, center=TRUE, scale=TRUE)
```
```{r fig.width=6, fig.height=6}
fviz_pca_var(cc_pca, col.var="contrib", 
             gradient.cols=c("#00AFBB","#E7B800","#FC4E07"),
             repel=TRUE)
##we pick purchase, purchases_trx, balance, cash_advance, cash_advance_frequency, cash advance_trx, purchase_frequency, oneoff_purchases, installments_purchases, purchases_installments_frequency, credit_limit
```

```{r}
fviz_nbclust(scale(cc), kmeans, method = "silhouette", k.max=15)
## choose cluster is 13(7 is also high)
fviz_nbclust(scale(cc), kmeans, method = "wss", k.max=15)
## choose cluster is 2, 4, 7, 9
```


```{r}
##Choose Dimensions
get_eigenvalue(cc_pca)
##Based on the eigenvalue, we want to choose eigenvalue>1, so we could choose Dimension with 5; however, since we want cumulative variance too small, we choose eigenvalue>0.7, so we choose Dimension with 8 which also has 85% of cumulative variance. 
```

```{r}
k=kmeans(scale(cc), 7, 25, 25)
fviz_cluster(k, scale(cc))
```

```{r}
table(k$cluster)
```
```{r}
k2=kmeans(scale(cc), 9, 25, 25)
fviz_cluster(k2, scale(cc))
```
```{r}
table(k2$cluster)
```
```{r}
k3=kmeans(scale(cc), 13, 25, 25)
fviz_cluster(k3, scale(cc))
```
```{r}
table(k3$cluster)
```
In the original model, we think k=9 is the best since each cluster has similar size. 
```{r}
## apply the features -- could use new data, or the original as I do below
c_pcs=predict(cc_pca, newdata=cc)
class(c_pcs)
c_pcs=as.data.frame(c_pcs)
head(c_pcs)
```
```{r}
c_pc=c_pcs[, 1:8]
head(c_pc)
```

```{r}
fviz_nbclust(scale(c_pc), kmeans, method = "silhouette", k.max=15)
## choose cluster is 2
fviz_nbclust(scale(c_pc), kmeans, method = "wss", k.max=15)
## choose cluster is 2, 5, 7, 9
```
```{r}
k4=kmeans(scale(c_pc), 2, 25, 25)
fviz_cluster(k4, scale(c_pc))
```
```{r}
table(k4$cluster)
```
```{r}
k5=kmeans(scale(c_pc), 5, 25, 25)
fviz_cluster(k5, scale(c_pc))
```
```{r}
table(k5$cluster)
```
```{r}
k6=kmeans(scale(c_pc), 7, 25, 25)
fviz_cluster(k6, scale(c_pc))
```
```{r}
table(k6$cluster)
```
```{r}
k7=kmeans(scale(c_pc), 9, 25, 25)
fviz_cluster(k7, scale(c_pc))
```
```{r}
table(k7$cluster)
```
Since we don't want the size of the cluster too small or larger and try to average the size of clusters, so we think the best k is 5 for the PCA model.

```{r}
##Results business related
##Add clustering back to the original dataset
c_pc$cluster<-k5$cluster
```
```{r}
plot_ly(x=c_pc[,1], y=c_pc[,2], z=c_pc[,3], type="scatter3d", mode="markers",color =factor(c_pc$cluster))
```
```{r}
cc$cluster<-k5$cluster
##Try different variables plotting with different cluster
ggplot(cc, aes(x=cluster, y=purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,4000)
```
```{r}
ggplot(cc, aes(x=cluster, y=purchases_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,1)
```
```{r}
ggplot(cc, aes(x=cluster, y=credit_limit, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,10000)
```
```{r}
ggplot(cc, aes(x=cluster, y=balance, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,7000)
```
```{r}
ggplot(cc, aes(x=cluster, y=balance_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0.5,1)
```
```{r}
ggplot(cc, aes(x=cluster, y=oneoff_purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,5000)
```
```{r}
ggplot(cc, aes(x=cluster, y=purchases_installments_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))
```
```{r}
ggplot(cc, aes(x=cluster, y=purchases_trx, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(1,100)
```
```{r}
ggplot(cc, aes(x=cluster, y=cash_advance, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,2000)
```
```{r}
ggplot(cc, aes(x=cluster, y=cash_advance_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,0.5)
```
```{r}
ggplot(cc, aes(x=cluster, y=cash_advance_trx, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,40)
```
```{r}
ggplot(cc, aes(x=cluster, y=installments_purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0, 5000)
```
```{r}
ggplot(cc, aes(x=cluster, y=prc_full_payment, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))
```
For cluster 1: low purchases, high balance, low oneoff_purchases, low prc_full_payment  
For cluster 2: high purchases, high purchases_frequency, high credit limit, high oneoff_purchases, high purchases_trx, low cash_advance, low cash_advance_trx, high prc_full_payment  
For cluster 3: low purchases, low purchase_frequency, low purchases_installments_frequency, low purchases_trx, low installments_purchases, low prc_full_payment, low oneoff_purchases_fr  
For cluster 4: low credit_limit, low balance_frequency, low installments_purchases, low purchases_trx, high cash_advance_frequency  
For cluster 5: high purchases_frequency, high purchases_installments_frequency, low cash_advance_trx, high installments_purchases, high purchases_trx, low cash_advances  

Change to better understanding words.
cluster 1: less repayment with low amount multiple times, and pay less  
cluster 2: spend more money, shopping more, high credit limit, buy expansive stuff, more purchases transaction, use cashless and amount small  
cluster 3: spend less money, shopping less, fewer installment payments, fewer transactions, less installment amount  
cluster 4: low credit limit, low using cards, low transactions, more frequently get cash  
cluster 5: more shopping, high frequent installment purchases, not really cashback, high amount of installment payments, high purchase transactions, less amount cash back  

**Summarize observations to features**
cluster1: scrimp and use credit cards for daily purchases  
cluster2: premium users with high spending behaviors  
cluster3: inactive users  
cluster4: new cardholders  
cluster5: installment users  


```{r}
##tSNE
cc2<-cc%>%select(-cluster)
cc_tsne=Rtsne(cc2,
               verbose=TRUE,
               max_iter=500,
               check_duplicates=FALSE)

## remember that this is for plotting, so we can get the 2d space from Y
class(cc_tsne)
names(cc_tsne)


## lets create the plot
tsne_proj=cc_tsne$Y
class(tsne_proj)
dim(tsne_proj)
head(tsne_proj)
nrow(cc) ==nrow(tsne_proj)
tsne_df=as.data.frame(tsne_proj)
plot(tsne_df$V1, tsne_df$V2, type="p", pch=19)

## just a big hairball, but lets clean it up and map onto it
cc_final=cbind(cc, tsne_df)
```
```{r}
fviz_nbclust(scale(tsne_proj), kmeans, method = "silhouette", k.max=15)
## choose cluster is 6
fviz_nbclust(scale(tsne_proj), kmeans, method = "wss", k.max=15)
## choose cluster is 3, 4, 7, 8
```
```{r}
z2<-scale(as.data.frame(tsne_proj))
k8=kmeans(z2, 3, 25, 25)
fviz_cluster(k8, z2)
```
```{r}
table(k8$cluster)
```
```{r}
k9=kmeans(z2, 4, 25, 25)
fviz_cluster(k9, z2)
```
```{r}
table(k9$cluster)
```
```{r}
k10=kmeans(z2, 6, 25, 25)
fviz_cluster(k10, z2)
```
```{r}
table(k10$cluster)
```
```{r}
k11=kmeans(z2, 7, 25, 25)
fviz_cluster(k11, z2)
```
```{r}
table(k11$cluster)
```
```{r}
k12=kmeans(z2, 8, 25, 25)
fviz_cluster(k12, z2)
```
```{r}
table(k12$cluster)
```
```{r}
k13=kmeans(z2, 5, 25, 25)
fviz_cluster(k13, z2)
```

```{r}
cc2$cluster<-k13$cluster
##Try different variables plotting with different cluster
ggplot(cc2, aes(x=cluster, y=purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,4000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=purchases_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,1)
```
```{r}
ggplot(cc2, aes(x=cluster, y=credit_limit, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,10000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=balance, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,6000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=balance_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0.5,1)
```
```{r}
ggplot(cc2, aes(x=cluster, y=oneoff_purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,5000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=purchases_installments_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))
```
```{r}
ggplot(cc2, aes(x=cluster, y=purchases_trx, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(1,100)
```
```{r}
ggplot(cc2, aes(x=cluster, y=cash_advance, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,2000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=cash_advance_frequency, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,0.5)
```
```{r}
ggplot(cc2, aes(x=cluster, y=cash_advance_trx, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0,30)
```
```{r}
ggplot(cc2, aes(x=cluster, y=installments_purchases, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))+
  ylim(0, 4000)
```
```{r}
ggplot(cc2, aes(x=cluster, y=prc_full_payment, fill=factor(cluster)))+
  geom_boxplot()+
  theme(panel.background = element_rect(fill="white"))
```
For cluster 1: low purchases, low purchase_frequency, 
For cluster 2: high purchases, high purchases_frequency, high credit limit, high oneoff_purchases, high purchases_trx, low cash_advance, low cash_advance_trx, high prc_full_payment  
For cluster 3: low purchases, low purchase_frequency, low purchases_installments_frequency, low purchases_trx, low installments_purchases, low prc_full_payment, low oneoff_purchases_fr  
For cluster 4: low credit_limit, low balance_frequency, low installments_purchases, low purchases_trx, high cash_advance_frequency  
For cluster 5: high purchases_frequency, high purchases_installments_frequency, low cash_advance_trx, high installments_purchases, high purchases_trx, low cash_advances  

Change to better understanding words.
cluster 1: less repayment with low amount multiple times, and pay less  
cluster 2: spend more money, shopping more, high credit limit, buy expansive stuff, more purchases transaction, use cashless and amount small  
cluster 3: spend less money, shopping less, fewer installment payments, fewer transactions, less installment amount  
cluster 4: low credit limit, low using cards, low transactions, more frequently get cash  
cluster 5: more shopping, high frequent installment purchases, not really cashback, high amount of installment payments, high purchase transactions, less amount cash back  

**Summarize observations to features**
cluster1: scrimp and use credit cards for daily purchases  
cluster2: premium users with high spending behaviors  
cluster3: inactive users  
cluster4: new cardholders  
cluster5: installment users  

```{r}

```


