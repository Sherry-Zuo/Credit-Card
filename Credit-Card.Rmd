---
title: "Credit Card Customer Segmentation"
subtitle: BA820 - Fall 2019
author: "team 7"
date: "11/20/2019"
output: pdf_document
---

**Team 7 Members:** Kunpeng Huang, Yoki Liu, Lyufan Pan, Yunlei Zhou, Jiayuan Zou, Sherry Zuo
```{r}
## load the packages
library(readr)
library(ggplot2)
library(dplyr)
library(purrr)
library(cluster)
library(factoextra)
library(tidyverse)
library(skimr)
library(corrplot)
library(plotly)
```

```{r}
## load the dataset
data<-read_csv("CC GENERAL.csv")
```

```{r}
colnames(data)<-tolower(colnames(data))
colnames(data)
```

```{r}
##Data Cleaning
cc<-data%>%select(-cust_id)
colmean <- function(x) replace(x, is.na(x), mean(x, na.rm = TRUE))
cc <- replace(cc, TRUE, lapply(cc, colmean))
glimpse(cc)
skim(cc)
##There are 17 numeric variables and 8950 observations. Replace NAs with colmeans. 
```
```{r}
##Explore data
ggplot(cc,aes(x=purchases_frequency)) +
  geom_histogram()
```
Based on this histigram, this graph shows us that the purchasing polarization. x-axis indicates that how frequently the purchases are being made, 1 = very frequently, and 0 = not very frequently. Most of transcations is concetred on the either not very frequently or very frequently group.
```{r}
ggplot(cc, aes(x = balance_frequency, y = balance, color = factor(tenure)))+
  geom_point(alpha = 0.2)
```

```{r fig.width=12, fig.height=12}
cc_c<-cor(cc)
corrplot(cc_c,
         type="upper",
         diag=F,
         method="color",
         order="hclust")
```
```{r}
##cash_advance_frequency with cash_advance_trx
##purchases with purchases_installments_frequency
##purchases_frequency with purchases_installments_frequency
ggplot(cc, aes(x = purchases_installments_frequency, y = purchases, color = purchases_frequency))+
  geom_line()
```

```{r}
cc_z = scale(cc)
#Manhattan distance: 
cc_dm = dist(cc_z, method="manhattan")
#Complete linkage: 
clust = hclust(cc_dm)
table(cutree(clust, k=7))
sapply(7:13, function(x) table(cutree(clust, k=x)))
```

```{r}
##Fit the PCA model
cc_pca=prcomp(cc, center=TRUE, scale=TRUE)
```
```{r fig.width=6, fig.height=6}
fviz_pca_var(cc_pca, col.var="contrib", 
             gradient.cols=c("#00AFBB","#E7B800","#FC4E07"),
             repel=TRUE)
```
```{r}
fviz_nbclust(scale(cc), kmeans, method = "silhouette", k.max=15)
## choose cluster is 13(7 is also high)
fviz_nbclust(scale(cc), kmeans, method = "wss", k.max=15)
## choose cluster is 2, 4, 7, 9
```


```{r}
##Choose Dimensions
get_eigenvalue(cc_pca)
##Based on the eigenvalue, we want to choose eigenvalue>1, so we could choose Dimension with 5; however, since we want cumulative variance too small, we choose eigenvalue>0.7, so we choose Dimension with 8 which also has 85% of cumulative variance. 
```

```{r}
k=kmeans(scale(cc), 7, 25, 25)
fviz_cluster(k, scale(cc))
```

```{r}
table(k$cluster)
```
```{r}
k2=kmeans(scale(cc), 9, 25, 25)
fviz_cluster(k2, scale(cc))
```
```{r}
table(k2$cluster)
```
```{r}
k3=kmeans(scale(cc), 13, 25, 25)
fviz_cluster(k3, scale(cc))
```
```{r}
table(k3$cluster)
```
In the original model, we think k=9 is the best since each cluster has similar size. 
```{r}
## apply the features -- could use new data, or the original as I do below
c_pcs=predict(cc_pca, newdata=cc)
class(c_pcs)
c_pcs=as.data.frame(c_pcs)
head(c_pcs)
```
```{r}
c_pc=c_pcs[, 1:8]
head(c_pc)
```

```{r}
fviz_nbclust(scale(c_pc), kmeans, method = "silhouette", k.max=15)
## choose cluster is 2
fviz_nbclust(scale(c_pc), kmeans, method = "wss", k.max=15)
## choose cluster is 2, 5, 7, 9
```
```{r}
k4=kmeans(scale(c_pc), 2, 25, 25)
fviz_cluster(k4, scale(c_pc))
```
```{r}
table(k4$cluster)
```
```{r}
k5=kmeans(scale(c_pc), 5, 25, 25)
fviz_cluster(k5, scale(c_pc))
```
```{r}
table(k5$cluster)
```
```{r}
k6=kmeans(scale(c_pc), 7, 25, 25)
fviz_cluster(k6, scale(c_pc))
```
```{r}
table(k6$cluster)
```
```{r}
k7=kmeans(scale(c_pc), 9, 25, 25)
fviz_cluster(k7, scale(c_pc))
```
```{r}
table(k7$cluster)
```
Since we don't want the size of cluster too small or larger, and try to average the size of clusters, so we think the best k is 5 for PCA model. 

```{r}
c_pc$cluster<-k5$cluster
```
```{r}
plot_ly(x=c_pc[,1], y=c_pc[,2], z=c_pc[,3], type="scatter3d", mode="markers",color =factor(c_pc$cluster))
```
```{r}
cc$cluster<-k5$cluster
ggplot(cc, aes(x=cluster, y=purchases, fill=factor(cluster)))+
  geom_boxplot()+
  ylim(0,3000)
```



